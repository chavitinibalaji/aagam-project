<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checkout - AAGAM</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Inter',sans-serif; }
    body { background:#f8f9fa; min-height:100vh; padding-bottom:140px; }
    .header {
      background:#fff;
      padding:14px 16px;
      font-size:18px;
      font-weight:700;
      box-shadow:0 2px 6px rgba(0,0,0,.08);
      position:sticky;
      top:0;
      z-index:100;
      text-align:center;
    }
    .container { padding:16px; max-width:900px; margin:0 auto; }
    .checkout-grid {
      display:grid;
      grid-template-columns:1fr 380px;
      gap:24px;
    }
    @media (max-width:992px) {
      .checkout-grid { grid-template-columns:1fr; }
    }
    .card {
      background:#fff;
      border-radius:16px;
      box-shadow:0 4px 16px rgba(0,0,0,.06);
      margin-bottom:24px;
      overflow:hidden;
    }
    .card-header {
      padding:16px 20px;
      font-size:16px;
      font-weight:700;
      background:#fafafa;
      border-bottom:1px solid #eee;
    }
    .card-body { padding:20px; }
    input, textarea, select {
      width:100%;
      padding:12px 14px;
      border:1px solid #ddd;
      border-radius:10px;
      margin-bottom:16px;
      font-size:14px;
    }
    input:focus, textarea:focus, select:focus {
      border-color:#ff3269;
      outline:none;
      box-shadow:0 0 0 3px rgba(255,50,105,.1);
    }
    .address-display {
      margin-bottom:16px;
      line-height:1.6;
    }
    .address-display strong { color:#333; }
    .change-address-btn {
      background:#ff3269;
      color:white;
      border:none;
      padding:10px 20px;
      border-radius:8px;
      cursor:pointer;
      font-weight:600;
    }
    .time-slots {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
      gap:12px;
      margin-top:12px;
    }
    .time-slot {
      padding:12px;
      border:1px solid #ddd;
      border-radius:10px;
      text-align:center;
      cursor:pointer;
      transition:all 0.2s;
    }
    .time-slot:hover { border-color:#ff3269; background:#fff5f8; }
    .time-slot.selected {
      border:2px solid #ff3269;
      background:#fff0f5;
      font-weight:600;
    }
    .time-slot.disabled {
      opacity:0.5;
      pointer-events:none;
      background:#f5f5f5;
    }
    .payment-methods {
      display:grid;
      gap:12px;
      margin-top:12px;
    }
    .payment-method {
      display:flex;
      align-items:center;
      gap:12px;
      padding:14px;
      border:1px solid #ddd;
      border-radius:12px;
      cursor:pointer;
      transition:all 0.2s;
    }
    .payment-method:hover { border-color:#ff3269; background:#fff5f8; }
    .payment-method.selected {
      border:2px solid #ff3269;
      background:#fff0f5;
    }
    .payment-icon { font-size:24px; }
    .bill-row {
      display:flex;
      justify-content:space-between;
      font-size:14px;
      margin:10px 0;
    }
    .bill-total {
      font-size:18px;
      font-weight:700;
      padding-top:12px;
      border-top:2px dashed #ddd;
    }
    .savings-box {
      background:#e8f5e9;
      border-radius:12px;
      padding:16px;
      margin:20px 0;
    }
    .savings-title {
      color:#2e7d32;
      font-weight:700;
      margin-bottom:12px;
      font-size:16px;
    }
    .savings-item {
      display:flex;
      justify-content:space-between;
      font-size:14px;
      margin:6px 0;
      color:#2e7d32;
    }
    .place-btn {
      width:100%;
      padding:16px;
      background:#ff3269;
      color:white;
      border:none;
      border-radius:12px;
      font-size:18px;
      font-weight:700;
      cursor:pointer;
      margin-top:20px;
      box-shadow:0 4px 12px rgba(255,50,105,.2);
    }
    .place-btn:disabled {
      background:#ccc;
      cursor:not-allowed;
    }
    .modal {
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.6);
      z-index:1000;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .modal-content {
      background:#fff;
      border-radius:16px;
      width:100%;
      max-width:480px;
      max-height:90vh;
      overflow-y:auto;
      box-shadow:0 10px 40px rgba(0,0,0,0.3);
    }
    .modal-header {
      padding:16px 20px;
      border-bottom:1px solid #eee;
      display:flex;
      justify-content:space-between;
      align-items:center;
      position:sticky;
      top:0;
      background:#fff;
      z-index:10;
    }
    .close-btn {
      background:none;
      border:none;
      font-size:32px;
      cursor:pointer;
      color:#777;
    }
    .toast {
      position:fixed;
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      background:#2e7d32;
      color:white;
      padding:12px 24px;
      border-radius:10px;
      z-index:1000;
      box-shadow:0 4px 12px rgba(0,0,0,.2);
      animation:slideUp 0.4s ease;
    }
    @keyframes slideUp {
      from { transform:translate(-50%,20px); opacity:0; }
      to { transform:translate(-50%,0); opacity:1; }
    }
  </style>
</head>
<body>

<div class="header">Checkout</div>

<div class="container">
  <div class="checkout-grid">

    <!-- Left Column -->
    <div>

      <!-- Delivery Address -->
      <div class="card">
        <div class="card-header">Delivery Address</div>
        <div class="card-body">
          <div class="address-display">
            <strong id="addressTypeDisplay">Home</strong><br>
            <span id="addressText">No address selected yet</span><br>
            <span id="contactInfo">Contact: Not set</span>
          </div>
          <button class="change-address-btn" onclick="openAddressModal()">
            Change / Add Address
          </button>
        </div>
      </div>

      <!-- Delivery Time Slots -->
      <div class="card">
        <div class="card-header">Delivery Time</div>
        <div class="card-body">
          <div class="time-slots" id="timeSlots">
            <!-- Time slots populated by JS -->
          </div>
        </div>
      </div>

      <!-- Payment Methods -->
      <div class="card">
        <div class="card-header">Payment Method</div>
        <div class="card-body">
          <div class="payment-methods">
            <div class="payment-method selected" data-method="cod">
              <i class="fas fa-money-bill-wave"></i>
              <div>
                <div class="payment-type">Cash on Delivery</div>
                <div class="payment-info">Pay when you receive</div>
              </div>
            </div>
            <div class="payment-method" data-method="upi">
              <i class="fas fa-mobile-alt"></i>
              <div>
                <div class="payment-type">UPI</div>
                <div class="payment-info">Google Pay, PhonePe, etc.</div>
              </div>
            </div>
            <div class="payment-method" data-method="card">
              <i class="fas fa-credit-card"></i>
              <div>
                <div class="payment-type">Card</div>
                <div class="payment-info">Credit / Debit Card</div>
              </div>
            </div>
          </div>

          <!-- UPI Section -->
          <div id="upiSection" style="margin-top:16px;display:none;">
            <input type="text" id="upiId" placeholder="yourname@okaxis / @ybl / @phonepe">
            <button style="margin-top:12px;width:100%;padding:12px;background:#ff3269;color:white;border:none;border-radius:10px;cursor:pointer;" onclick="generateUpiQr()">
              Generate QR & Pay
            </button>
          </div>
        </div>
      </div>

      <!-- Order Notes -->
      <div class="card">
        <div class="card-header">Order Notes (Optional)</div>
        <div class="card-body">
          <textarea id="orderNotes" rows="3" placeholder="Any special instructions? (e.g. call before delivery, leave at gate)"></textarea>
        </div>
      </div>
    </div>

    <!-- Right Column: Summary -->
    <div>
      <div class="card">
        <div class="card-header">Order Summary</div>
        <div class="card-body">
          <div id="orderItems"></div>
          <div class="bill-row"><span>Subtotal</span><span id="subtotal">₹0</span></div>
          <div class="bill-row"><span>Delivery Fee</span><span id="deliveryFee">₹0</span></div>
          <div class="bill-row"><span>Handling Fee</span><span>FREE</span></div>
          <div id="discountRow" class="bill-row discount-row" style="display:none;">
            <span>Discount</span><span>-₹<span id="discountAmount">0</span></span>
          </div>
          <div class="bill-total">
            <span>Total</span>
            <span id="grandTotal">₹0</span>
          </div>

          <div class="savings-box" id="savingsBox" style="display:none;">
            <div class="savings-title">Savings on this order</div>
            <div class="savings-item"><span>Discount on MRP</span><span id="mrpDiscount">₹0</span></div>
            <div class="savings-item"><span>FREE delivery savings</span><span id="deliverySavings">₹0</span></div>
            <div class="savings-item"><span>Savings on Handling fee</span><span>₹10</span></div>
          </div>

          <button class="place-btn" id="placeOrderBtn" onclick="placeOrder()">
            Place Order • ₹<span id="finalTotalBtn">0</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Address Modal -->
<div class="modal" id="addressModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Add / Change Address</h3>
      <button class="close-btn" onclick="closeModal()">×</button>
    </div>
    <div class="modal-body">
      <form id="addressForm">
        <select id="addressType" required>
          <option value="Home">Home</option>
          <option value="Work">Work</option>
          <option value="Other">Other</option>
        </select>
        <textarea id="fullAddress" rows="3" placeholder="House no, Street, Area, Landmark, City - PIN" required></textarea>
        <input type="text" id="contactName" placeholder="Contact Name" required>
        <input type="tel" id="contactPhone" placeholder="Contact Phone (10 digits)" pattern="[0-9]{10}" required>
        <button type="submit" class="place-btn" style="margin-top:20px;">Save Address</button>
      </form>
    </div>
  </div>
</div>

<script>
// ──────────────────────────────────────────────── Cart & Address Logic
let cart = JSON.parse(localStorage.getItem('aagam_cart') || '[]');

// Load saved address on page load
const savedAddr = JSON.parse(localStorage.getItem('aagam_default_address'));
if (savedAddr) {
  document.getElementById('addressTypeDisplay').textContent = savedAddr.type;
  document.getElementById('addressText').textContent = savedAddr.address;
  document.getElementById('contactInfo').textContent = `Contact • ${savedAddr.phone}`;
} else {
  document.getElementById('addressText').textContent = 'Please select or add an address';
}

// ──────────────────────────────────────────────── Open / Close Address Modal
function openAddressModal() {
  document.getElementById('addressModal').style.display = 'flex';
  // Pre-fill if editing
  if (savedAddr) {
    document.getElementById('addressType').value = savedAddr.type;
    document.getElementById('fullAddress').value = savedAddr.address;
    document.getElementById('contactName').value = savedAddr.name || '';
    document.getElementById('contactPhone').value = savedAddr.phone;
  }
}

function closeModal() {
  document.getElementById('addressModal').style.display = 'none';
}

// ──────────────────────────────────────────────── Save Address
document.getElementById('addressForm').addEventListener('submit', e => {
  e.preventDefault();

  const type = document.getElementById('addressType').value;
  const address = document.getElementById('fullAddress').value.trim();
  const name = document.getElementById('contactName').value.trim();
  const phone = document.getElementById('contactPhone').value.trim();

  if (!address || !name || !phone || phone.length !== 10) {
    alert('Please fill all required fields correctly');
    return;
  }

  const addressData = { type, address, name, phone };
  localStorage.setItem('aagam_default_address', JSON.stringify(addressData));

  // Update display
  document.getElementById('addressTypeDisplay').textContent = type;
  document.getElementById('addressText').textContent = address;
  document.getElementById('contactInfo').textContent = `Contact • ${phone}`;

  closeModal();
  showToast('Address saved successfully!');
});

// ──────────────────────────────────────────────── Toast Notification
function showToast(message) {
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// ──────────────────────────────────────────────── Rest of your checkout logic (placeOrder, Razorpay, etc.)
// ... keep your existing Razorpay + placeOrder + saveOrderAndRedirect code here ...
// Make sure saveOrderAndRedirect uses the saved address:
function saveOrderAndRedirect(orderData, paymentStatus) {
  const savedAddr = JSON.parse(localStorage.getItem('aagam_default_address')) || {};
  orderData.address = savedAddr.address || 'Not set';
  // ... rest of your save logic ...
}
</script>
<!-- Add this script in <head> or before closing </body> -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
// Call this when user clicks "Place Order"
async function placeOrder() {
  const grandTotal = parseFloat(document.getElementById('grandTotal').textContent.replace('₹', '')) || 0;

  if (grandTotal <= 0) {
    alert('Cart is empty!');
    return;
  }

  try {
    // 1. Create Razorpay Order from backend
    const response = await fetch('/api/payments/create-order', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('token')}` // your JWT
      },
      body: JSON.stringify({
        amount: grandTotal,
        receipt: `order_${Date.now()}`,
        notes: { source: 'web_checkout' }
      })
    });

    const data = await response.json();

    if (!data.success) {
      alert(data.message || 'Failed to create order');
      return;
    }

    // 2. Open Razorpay Checkout
    const options = {
      key: data.key,                    // your Razorpay Key ID
      amount: data.amount,
      currency: data.currency,
      name: 'AAGAM – Groceries in Minutes',
      description: 'Grocery Order Payment',
      order_id: data.orderId,
      image: 'https://your-logo-url.png', // optional
      handler: async function (response) {
        // Payment success → verify on server
        const verifyRes = await fetch('/api/payments/verify', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify({
            razorpay_order_id: response.razorpay_order_id,
            razorpay_payment_id: response.razorpay_payment_id,
            razorpay_signature: response.razorpay_signature
          })
        });

        const verifyData = await verifyRes.json();

        if (verifyData.success) {
          alert('Payment successful! Order placed.');
          // Clear cart, redirect to order confirmation
          localStorage.removeItem('aagamCart');
          window.location.href = '/orders.html';
        } else {
          alert('Payment verification failed. Please contact support.');
        }
      },
      prefill: {
        name: 'User Name',    // fetch from profile
        email: 'user@example.com',
        contact: '9999999999'
      },
      theme: {
        color: '#ff3269' // your brand color
      }
    };

    const rzp = new Razorpay(options);
    rzp.open();

  } catch (err) {
    console.error(err);
    alert('Something went wrong. Please try again.');
  }
}
</script>
</body>
</html>
