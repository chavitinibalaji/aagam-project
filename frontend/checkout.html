<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AAGAM - Checkout</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/cart.css">
    <style>
        /* Additional styles for better UX */
        .time-slot.disabled {
            opacity: 0.5;
            pointer-events: none;
            background: #f0f0f0;
            cursor: not-allowed;
        }
        .time-slot.selected {
            border: 2px solid #0c831f;
            background: #e8f5e9;
        }
        .est-time {
            font-size: 12px;
            color: #0c831f;
            margin-top: 4px;
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #0c831f;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .place-order-btn {
            width: 100%;
            padding: 14px;
            background: #0c831f;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 16px;
        }
        .place-order-btn:disabled {
            background: #aaa;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

    <!-- Header -->
    <div id="header-placeholder"></div>

    <div class="checkout-container">
        <div class="checkout-header">
            <h1>Checkout</h1>
        </div>

        <div class="checkout-content">
            <div class="checkout-main">

                <!-- Delivery Address -->
                <div class="checkout-section">
                    <h2>üìç Delivery Address</h2>
                    <div class="address-list">
                        <div class="address-card selected">
                            <div class="address-header">
                                <span class="address-type">Home</span>
                                <button class="edit-btn" onclick="editAddress()">Edit</button>
                            </div>
                            <div class="address-details">
                                <p id="selectedAddress">Loading saved address...</p>
                                <p class="contact-info">Contact ‚Ä¢ +91 XXXXXX</p>
                            </div>
                        </div>
                        <button class="add-address-btn" onclick="addNewAddress()">
                            ‚ûï Add New Address
                        </button>
                    </div>
                </div>

                <!-- Delivery Time Slots (dynamic) -->
                <div class="checkout-section">
                    <h2>‚è∞ Delivery Time</h2>
                    <div class="time-slots" id="timeSlots"></div>
                </div>

                <!-- Payment Methods -->
                <div class="checkout-section">
                    <h2>üí≥ Payment Method</h2>
                    <div class="payment-methods">
                        <div class="payment-method selected" data-method="card">
                            <div class="payment-icon">üí≥</div>
                            <div class="payment-details">
                                <div class="payment-type">Card</div>
                                <div class="payment-info">Credit / Debit Card</div>
                            </div>
                        </div>
                        <div class="payment-method" data-method="upi">
                            <div class="payment-icon">üì±</div>
                            <div class="payment-details">
                                <div class="payment-type">UPI</div>
                                <div class="payment-info">Google Pay, PhonePe, etc.</div>
                            </div>
                        </div>
                        <div class="payment-method" data-method="cod">
                            <div class="payment-icon">üíµ</div>
                            <div class="payment-details">
                                <div class="payment-type">Cash on Delivery</div>
                                <div class="payment-info">Pay when you receive</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Notes -->
                <div class="checkout-section">
                    <h2>üìù Order Notes</h2>
                    <textarea placeholder="Any special instructions? (e.g. call before delivery, leave at gate)" id="orderNotes" rows="3"></textarea>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="checkout-sidebar">
                <div class="order-summary-card">
                    <h3>Order Summary</h3>
                    <div class="order-items" id="orderItems"></div>
                    <div class="order-totals">
                        <div class="summary-row">
                            <span>Subtotal</span>
                            <span id="checkoutSubtotal">‚Çπ0</span>
                        </div>
                        <div class="summary-row">
                            <span>Delivery Fee</span>
                            <span id="checkoutDeliveryFee">‚Çπ0</span>
                        </div>
                        <div class="summary-row">
                            <span>GST (5%)</span>
                            <span id="checkoutGst">‚Çπ0</span>
                        </div>
                        <div class="summary-row total-row">
                            <span>Total</span>
                            <span id="checkoutTotal">‚Çπ0</span>
                        </div>
                    </div>
                    <button class="place-order-btn" onclick="placeOrder()" id="placeOrderBtn">
                        Place Order ‚Ä¢ <span id="finalTotalBtn">‚Çπ0</span>
                    </button>
                    <div class="order-promise">
                        <div class="promise-item"><span>üîí</span> Secure</div>
                        <div class="promise-item"><span>üöö</span> Fast Delivery</div>
                        <div class="promise-item"><span>‚≠ê</span> Quality</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div id="footer-placeholder"></div>

    <!-- Address Modal -->
    <div class="modal" id="addressModal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add / Edit Address</h3>
                <button class="close-btn" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="addressForm">
                    <div class="form-group">
                        <label>Address Type</label>
                        <select id="addressType">
                            <option value="Home">Home</option>
                            <option value="Work">Work</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Full Address *</label>
                        <textarea id="fullAddress" rows="3" required placeholder="House no, Street, Area, City - PIN"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Landmark (optional)</label>
                        <input type="text" id="landmark" placeholder="e.g. Near RTC Complex">
                    </div>
                    <div class="form-group">
                        <label>Contact Name *</label>
                        <input type="text" id="contactName" required>
                    </div>
                    <div class="form-group">
                        <label>Contact Phone *</label>
                        <input type="tel" id="contactPhone" required pattern="[0-9]{10}">
                    </div>
                    <button type="submit" class="save-address-btn">Save Address</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // RAZORPAY INTEGRATION + CHECKOUT LOGIC
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        // Load Razorpay SDK dynamically
        function loadRazorpayScript() {
            return new Promise((resolve) => {
                if (window.Razorpay) return resolve();
                const script = document.createElement('script');
                script.src = 'https://checkout.razorpay.com/v1/checkout.js';
                script.onload = resolve;
                script.onerror = () => alert('Failed to load Razorpay. Check internet connection.');
                document.body.appendChild(script);
            });
        }

        // Simulated backend order creation (replace with real API call later)
        async function createRazorpayOrder(amountInPaise) {
            // In production: fetch('/api/create-razorpay-order', { method: 'POST', body: JSON.stringify({amount}) })
            // For testing we simulate:
            return {
                id: 'order_' + Math.random().toString(36).substring(2, 12),
                amount: amountInPaise,
                currency: 'INR',
                status: 'created'
            };
        }

        // Main place order function
        async function placeOrder() {
            const btn = document.getElementById('placeOrderBtn');
            btn.disabled = true;
            btn.textContent = 'Processing...';

            const cart = JSON.parse(localStorage.getItem('aagam_cart') || '[]');
            if (cart.length === 0) {
                alert('Your cart is empty!');
                btn.disabled = false;
                btn.innerHTML = 'Place Order ‚Ä¢ <span id="finalTotalBtn">‚Çπ0</span>';
                return;
            }

            const paymentMethod = document.querySelector('.payment-method.selected')?.dataset.method || 'cod';
            const totalText = document.getElementById('checkoutTotal').textContent.replace('‚Çπ','').replace(/,/g,'');
            const amountInPaise = Math.round(parseFloat(totalText) * 100);

            const selectedSlotElem = document.querySelector('.time-slot.selected');
            const deliveryTime = selectedSlotElem ? selectedSlotElem.querySelector('.slot-time').textContent : 'Not selected';

            const orderData = {
                id: 'ORD-' + Date.now(),
                items: cart,
                address: document.getElementById('selectedAddress').textContent,
                deliveryTime,
                paymentMethod: paymentMethod.toUpperCase(),
                notes: document.getElementById('orderNotes').value.trim(),
                total: `‚Çπ${totalText}`,
                timestamp: new Date().toISOString()
            };

            if (paymentMethod === 'cod') {
                // Cash on Delivery - direct success
                finalizeOrder(orderData, 'cod');
                return;
            }

            // Online Payment (Card / UPI) ‚Üí Razorpay
            try {
                await loadRazorpayScript();

                const razorOrder = await createRazorpayOrder(amountInPaise);

                const options = {
                    key: 'rzp_test_your_test_key_here',          // ‚Üê REPLACE WITH YOUR TEST KEY ID
                    amount: razorOrder.amount,
                    currency: razorOrder.currency,
                    name: 'AAGAM - Quick Commerce',
                    description: `Order #${orderData.id} - Groceries`,
                    order_id: razorOrder.id,
                    image: 'https://via.placeholder.com/128?text=AAGAM', // optional logo
                    prefill: {
                        name: document.querySelector('.contact-info').textContent.split('‚Ä¢')[0]?.trim() || '',
                        contact: document.querySelector('.contact-info').textContent.split('‚Ä¢')[1]?.trim() || ''
                    },
                    theme: { color: '#0c831f' },
                    handler: function (response) {
                        // Payment successful
                        orderData.razorpay_payment_id = response.razorpay_payment_id;
                        orderData.razorpay_order_id   = response.razorpay_order_id;
                        orderData.razorpay_signature  = response.razorpay_signature;
                        finalizeOrder(orderData, 'paid');
                    },
                    modal: {
                        ondismiss: function () {
                            showToast('Payment window closed');
                            btn.disabled = false;
                            btn.innerHTML = `Place Order ‚Ä¢ ‚Çπ${totalText}`;
                        }
                    }
                };

                const rzp = new Razorpay(options);
                rzp.open();

            } catch (err) {
                console.error(err);
                showToast('Payment setup failed. Please try again.');
                btn.disabled = false;
                btn.innerHTML = `Place Order ‚Ä¢ ‚Çπ${totalText}`;
            }
        }

        function finalizeOrder(orderData, status) {
            let orders = JSON.parse(localStorage.getItem('aagam_orders') || '[]');
            orders.push({ ...orderData, status, paymentStatus: status === 'paid' ? 'Success' : 'COD' });
            localStorage.setItem('aagam_orders', JSON.stringify(orders));

            localStorage.removeItem('aagam_cart');

            const msg = status === 'paid' 
                ? 'Payment successful! Order placed üéâ' 
                : 'Order placed successfully (Cash on Delivery)';

            showToast(msg);

            setTimeout(() => {
                window.location.href = 'orders.html';
            }, 1800);
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Existing helper functions (time slots, load data, etc.)
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        const now = new Date();
        const currentHour = now.getHours();
        const currentMin  = now.getMinutes();

        function formatTime(h, m = 0) {
            const period = h >= 12 ? 'PM' : 'AM';
            const hh = h % 12 || 12;
            return `${hh}:${m.toString().padStart(2,'0')} ${period}`;
        }

        function generateTimeSlots() {
            const container = document.getElementById('timeSlots');
            container.innerHTML = '';

            const slots = [];

            // Fastest available (20‚Äì45 min est)
            if (currentHour < 22) {
                let startH = currentHour;
                let startM = currentMin + 20;
                if (startM >= 60) { startH++; startM -= 60; }
                const endH = startH + (startM > 30 ? 1 : 2);
                slots.push({
                    time: `Now ‚Äì ${formatTime(endH, startM)}`,
                    info: `Today ‚Ä¢ Fastest (~${20 + Math.floor(Math.random()*26)} min est.)`,
                    disabled: false
                });
            }

            if (currentHour < 19) {
                slots.push({
                    time: '6:00 PM - 9:00 PM',
                    info: 'Today ‚Ä¢ Evening',
                    disabled: currentHour >= 18
                });
            }

            slots.push(
                { time: '8:00 AM - 11:00 AM', info: 'Tomorrow ‚Ä¢ Morning', disabled: false },
                { time: '2:00 PM - 5:00 PM',  info: 'Tomorrow ‚Ä¢ Afternoon', disabled: false }
            );

            slots.forEach((s, i) => {
                const div = document.createElement('div');
                div.className = 'time-slot' + (s.disabled ? ' disabled' : '');
                if (i === 0 && !s.disabled) div.classList.add('selected');
                div.innerHTML = `
                    <div class="slot-time">${s.time}</div>
                    <div class="slot-info">${s.info}</div>
                    ${s.info.includes('min est.') ? '<div class="est-time">Estimated delivery shown</div>' : ''}
                `;
                div.addEventListener('click', () => {
                    if (!s.disabled) {
                        document.querySelectorAll('.time-slot').forEach(el => el.classList.remove('selected'));
                        div.classList.add('selected');
                    }
                });
                container.appendChild(div);
            });
        }

        function loadCheckoutData() {
            const cart = JSON.parse(localStorage.getItem('aagam_cart') || '[]');
            if (cart.length === 0) {
                window.location.href = 'cart.html';
                return;
            }

            const itemsDiv = document.getElementById('orderItems');
            itemsDiv.innerHTML = '';
            let subtotal = 0;

            cart.forEach(item => {
                const itemTotal = item.price * item.qty;
                subtotal += itemTotal;
                const div = document.createElement('div');
                div.className = 'order-item';
                div.innerHTML = `
                    <div class="item-info">
                        <span class="item-name">${item.name}</span>
                        <span class="item-qty">√ó${item.qty}</span>
                    </div>
                    <span class="item-price">‚Çπ${itemTotal.toLocaleString('en-IN')}</span>
                `;
                itemsDiv.appendChild(div);
            });

            const deliveryFee = subtotal >= 199 ? 0 : 39;
            const gst = Math.round(subtotal * 0.05);
            const total = subtotal + deliveryFee + gst;

            document.getElementById('checkoutSubtotal').textContent = `‚Çπ${subtotal.toLocaleString('en-IN')}`;
            document.getElementById('checkoutDeliveryFee').textContent = `‚Çπ${deliveryFee}`;
            document.getElementById('checkoutGst').textContent = `‚Çπ${gst.toLocaleString('en-IN')}`;
            document.getElementById('checkoutTotal').textContent = `‚Çπ${total.toLocaleString('en-IN')}`;
            document.getElementById('finalTotalBtn').textContent = `‚Çπ${total.toLocaleString('en-IN')}`;
        }

        function setupEventListeners() {
            document.querySelectorAll('.payment-method').forEach(el => {
                el.addEventListener('click', () => {
                    document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
                    el.classList.add('selected');
                });
            });

            document.getElementById('addressForm').addEventListener('submit', e => {
                e.preventDefault();
                saveAddress();
            });
        }

        function saveAddress() {
            const address = document.getElementById('fullAddress').value.trim();
            if (!address) return alert('Please enter full address');

            const type  = document.getElementById('addressType').value;
            const name  = document.getElementById('contactName').value;
            const phone = document.getElementById('contactPhone').value;
            const landmark = document.getElementById('landmark').value.trim();

            const display = landmark ? `${address}, ${landmark}` : address;

            document.getElementById('selectedAddress').textContent = display;
            document.querySelector('.contact-info').textContent = `${name} ‚Ä¢ ${phone}`;
            document.querySelector('.address-type').textContent = type;

            localStorage.setItem('aagam_default_address', JSON.stringify({type, address: display, name, phone}));

            closeModal();
            showToast('Address saved successfully');
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3200);
        }

        function closeModal() {
            document.getElementById('addressModal').style.display = 'none';
        }

        function addNewAddress() {
            document.getElementById('addressForm').reset();
            document.getElementById('addressModal').style.display = 'block';
        }

        function editAddress() {
            addNewAddress();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            generateTimeSlots();
            loadCheckoutData();
            setupEventListeners();

            // Load saved address
            const saved = JSON.parse(localStorage.getItem('aagam_default_address'));
            if (saved) {
                document.getElementById('selectedAddress').textContent = saved.address;
                document.querySelector('.contact-info').textContent = `${saved.name} ‚Ä¢ ${saved.phone}`;
                document.querySelector('.address-type').textContent = saved.type;
            }

            // Preload Razorpay script (optional but improves UX)
            loadRazorpayScript();
        });
    </script>
</body>
</html>
