<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AAGAM Admin - Orders Management</title>
    <link rel="stylesheet" href="css/admin.css">
    <style>
        .orders-container { padding: 20px; }
        .orders-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .orders-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-value { font-size: 24px; font-weight: bold; color: #3498db; }
        .stat-label { color: #666; margin-top: 5px; }
        .orders-table { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .orders-table table { width: 100%; border-collapse: collapse; }
        .orders-table th, .orders-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        .orders-table th { background: #f8f9fa; font-weight: 600; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-confirmed { background: #cce5ff; color: #004085; }
        .status-shipped { background: #d1ecf1; color: #0c5460; }
        .status-delivered { background: #d4edda; color: #155724; }
        .status-cancelled { background: #f8d7da; color: #721c24; }
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .btn-primary { background: #3498db; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .filters { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { font-size: 14px; font-weight: 500; margin-bottom: 5px; }
        .filter-group select, .filter-group input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .order-details-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .order-details-content { background: white; margin: 2% auto; padding: 20px; border-radius: 8px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; }
        .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .order-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .order-items { margin-bottom: 20px; }
        .order-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .connection-status { position: fixed; top: 10px; right: 10px; padding: 5px 10px; border-radius: 20px; font-size: 12px; z-index: 1000; }
        .connection-status.connected { background: #d4edda; color: #155724; }
        .connection-status.disconnected { background: #f8d7da; color: #721c24; }
        .real-time-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #28a745; margin-left: 5px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .notification-toast { position: fixed; top: 20px; right: 20px; background: #d4edda; color: #155724; padding: 12px 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 1000; animation: slideIn 0.3s ease; }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>AAGAM Admin</h2>
        </div>
        <nav class="sidebar-nav">
            <a href="index.html" class="nav-item">
                <span class="icon">ðŸ“Š</span> Dashboard
            </a>
            <a href="products.html" class="nav-item">
                <span class="icon">ðŸ“¦</span> Products
            </a>
            <a href="orders.html" class="nav-item active">
                <span class="icon">ðŸ“‹</span> Orders
            </a>
            <a href="inventory.html" class="nav-item">
                <span class="icon">ðŸ“ˆ</span> Inventory
            </a>
            <a href="#" class="nav-item">
                <span class="icon">ðŸ‘¥</span> Users
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Topbar -->
        <div class="topbar">
            <div class="topbar-left">
                <button class="menu-toggle" id="menuToggle">â˜°</button>
                <h1>Orders Management <span class="real-time-indicator" id="realTimeIndicator"></span></h1>
            </div>
            <div class="topbar-right">
                <div class="notifications">
                    <span class="icon">ðŸ””</span>
                    <span class="badge" id="notificationBadge">0</span>
                </div>
                <div class="user-profile">
                    <span class="icon">ðŸ‘¤</span>
                    <span>Admin</span>
                </div>
            </div>
        </div>

        <!-- Orders Content -->
        <div class="orders-container">
            <!-- Stats Cards -->
            <div class="orders-stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalOrders">0</div>
                    <div class="stat-label">Total Orders</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pendingOrders">0</div>
                    <div class="stat-label">Pending Orders</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="todayRevenue">â‚¹0</div>
                    <div class="stat-label">Today's Revenue</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgOrderValue">â‚¹0</div>
                    <div class="stat-label">Avg Order Value</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters">
                <div class="filter-group">
                    <label for="statusFilter">Status</label>
                    <select id="statusFilter">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="confirmed">Confirmed</option>
                        <option value="shipped">Shipped</option>
                        <option value="delivered">Delivered</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="dateFilter">Date</label>
                    <input type="date" id="dateFilter">
                </div>
                <div class="filter-group">
                    <label for="searchFilter">Search</label>
                    <input type="text" id="searchFilter" placeholder="Order ID or Customer">
                </div>
            </div>

            <!-- Orders Table -->
            <div class="orders-table">
                <table>
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Items</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                        <!-- Orders will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div class="order-details-modal" id="orderDetailsModal">
        <div class="order-details-content">
            <div class="order-header">
                <h3>Order Details - <span id="modalOrderId"></span></h3>
                <button onclick="closeOrderDetails()" style="background: none; border: none; font-size: 24px; cursor: pointer;">Ã—</button>
            </div>

            <div class="order-info">
                <div>
                    <strong>Customer:</strong> <span id="modalCustomerName"></span><br>
                    <strong>Phone:</strong> <span id="modalCustomerPhone"></span><br>
                    <strong>Email:</strong> <span id="modalCustomerEmail"></span>
                </div>
                <div>
                    <strong>Order Date:</strong> <span id="modalOrderDate"></span><br>
                    <strong>Delivery Address:</strong> <span id="modalDeliveryAddress"></span><br>
                    <strong>Payment Method:</strong> <span id="modalPaymentMethod"></span>
                </div>
                <div>
                    <strong>Status:</strong> <span id="modalOrderStatus"></span><br>
                    <strong>Total Amount:</strong> <span id="modalOrderTotal"></span><br>
                    <strong>Items:</strong> <span id="modalOrderItemsCount"></span>
                </div>
            </div>

            <div class="order-items">
                <h4>Order Items</h4>
                <div id="modalOrderItems">
                    <!-- Order items will be loaded here -->
                </div>
            </div>

            <div style="text-align: right; margin-top: 20px;">
                <select id="statusUpdateSelect" style="padding: 8px; margin-right: 10px;">
                    <option value="pending">Pending</option>
                    <option value="confirmed">Confirmed</option>
                    <option value="shipped">Shipped</option>
                    <option value="delivered">Delivered</option>
                    <option value="cancelled">Cancelled</option>
                </select>
                <button class="btn btn-primary" onclick="updateOrderStatus()">Update Status</button>
                <button class="btn btn-secondary" onclick="closeOrderDetails()">Close</button>
            </div>
        </div>
    </div>

    <!-- Connection Status -->
    <div class="connection-status" id="connectionStatus">Connecting...</div>

    <script src="js/admin-orders.js"></script>
    <script>
        // Real-time WebSocket connection for admin orders
        class AdminOrdersApp {
            constructor() {
                this.ws = null;
                this.orders = [];
                this.filteredOrders = [];
                this.connectionStatus = 'disconnected';
                this.currentOrderId = null;
                this.init();
            }

            init() {
                this.connectWebSocket();
                this.setupEventListeners();
                this.loadOrders();
                this.updateStats();
            }

            // WebSocket connection
            connectWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}`;

                try {
                    this.ws = new WebSocket(wsUrl);
                    this.updateConnectionStatus('connecting');

                    this.ws.onopen = () => {
                        this.updateConnectionStatus('connected');
                        this.authenticate();
                        this.showNotification('Connected to real-time server', 'success');
                    };

                    this.ws.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        this.handleWebSocketMessage(data);
                    };

                    this.ws.onclose = () => {
                        this.updateConnectionStatus('disconnected');
                        this.showNotification('Disconnected from server', 'warning');
                        // Auto reconnect
                        setTimeout(() => this.connectWebSocket(), 5000);
                    };

                    this.ws.onerror = () => {
                        this.updateConnectionStatus('error');
                    };
                } catch (error) {
                    console.error('WebSocket connection failed:', error);
                    this.updateConnectionStatus('error');
                }
            }

            // Authenticate as admin
            authenticate() {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({
                        type: 'admin_auth',
                        token: localStorage.getItem('admin_token') || 'admin_session'
                    }));
                }
            }

            // Handle WebSocket messages
            handleWebSocketMessage(data) {
                console.log('Admin orders received:', data.type);

                switch (data.type) {
                    case 'new_order':
                        this.onNewOrder(data.order);
                        break;
                    case 'order_updated':
                        this.onOrderUpdated(data.order);
                        break;
                    case 'order_cancelled':
                        this.onOrderCancelled(data.orderId);
                        break;
                    case 'rider_assigned':
                        this.onRiderAssigned(data);
                        break;
                    case 'delivery_completed':
                        this.onDeliveryCompleted(data);
                        break;
                }
            }

            // Real-time order updates
            onNewOrder(order) {
                this.orders.unshift(order);
                this.applyFilters();
                this.updateStats();
                this.showNotification(`New order received: ${order.id}`, 'success');
                this.updateNotificationBadge();
            }

            onOrderUpdated(order) {
                const index = this.orders.findIndex(o => o.id === order.id);
                if (index !== -1) {
                    this.orders[index] = order;
                    this.applyFilters();
                    this.updateStats();
                    this.showNotification(`Order ${order.id} status updated to ${order.status}`, 'info');
                }
            }

            onOrderCancelled(orderId) {
                this.orders = this.orders.filter(o => o.id !== orderId);
                this.applyFilters();
                this.updateStats();
                this.showNotification(`Order ${orderId} cancelled`, 'warning');
            }

            onRiderAssigned(data) {
                const order = this.orders.find(o => o.id === data.orderId);
                if (order) {
                    order.riderId = data.riderId;
                    order.status = 'shipped';
                    this.applyFilters();
                    this.showNotification(`Rider assigned to order ${data.orderId}`, 'info');
                }
            }

            onDeliveryCompleted(data) {
                const order = this.orders.find(o => o.id === data.deliveryId);
                if (order) {
                    order.status = 'delivered';
                    order.deliveredAt = new Date().toISOString();
                    this.applyFilters();
                    this.updateStats();
                    this.showNotification(`Order ${data.deliveryId} delivered!`, 'success');
                }
            }

            // Load orders from API
            async loadOrders() {
                try {
                    const response = await fetch('/api/orders');
                    const data = await response.json();
                    this.orders = data.orders || [];
                    this.applyFilters();
                    this.updateStats();
                } catch (error) {
                    console.error('Error loading orders:', error);
                    // Fallback to mock data
                    this.orders = this.generateMockOrders();
                    this.applyFilters();
                    this.updateStats();
                }
            }

            // Generate mock orders for demo
            generateMockOrders() {
                const statuses = ['pending', 'confirmed', 'shipped', 'delivered'];
                const customers = ['John Doe', 'Jane Smith', 'Bob Johnson', 'Alice Brown', 'Charlie Wilson'];
                const items = [
                    [{ name: 'Aashirvaad Atta', quantity: 2, price: 120 }],
                    [{ name: 'Fresh Milk', quantity: 1, price: 60 }],
                    [{ name: 'Fresh Vegetables', quantity: 3, price: 150 }],
                    [{ name: 'Rice Pack', quantity: 1, price: 200 }]
                ];

                return Array.from({ length: 20 }, (_, i) => {
                    const orderItems = items[Math.floor(Math.random() * items.length)];
                    const total = orderItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);

                    return {
                        id: `ORD${String(1000 + i).padStart(4, '0')}`,
                        customerName: customers[Math.floor(Math.random() * customers.length)],
                        customerPhone: '+91' + Math.floor(Math.random() * 9000000000 + 1000000000),
                        customerEmail: `customer${i}@example.com`,
                        items: orderItems,
                        total: total,
                        status: statuses[Math.floor(Math.random() * statuses.length)],
                        orderDate: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toISOString(),
                        deliveryAddress: `${Math.floor(Math.random() * 999) + 1} Main Street, City`,
                        paymentMethod: Math.random() > 0.5 ? 'COD' : 'Online'
                    };
                });
            }

            // Render orders table
            renderOrdersTable() {
                const tbody = document.getElementById('ordersTableBody');
                tbody.innerHTML = '';

                this.filteredOrders.forEach(order => {
                    const row = document.createElement('tr');
                    const itemsCount = order.items.reduce((sum, item) => sum + item.quantity, 0);
                    const orderDate = new Date(order.orderDate).toLocaleDateString();

                    row.innerHTML = `
                        <td>${order.id}</td>
                        <td>${order.customerName}</td>
                        <td>${itemsCount} items</td>
                        <td>â‚¹${order.total}</td>
                        <td><span class="status-badge status-${order.status}">${order.status.charAt(0).toUpperCase() + order.status.slice(1)}</span></td>
                        <td>${orderDate}</td>
                        <td>
                            <button class="btn btn-primary" onclick="adminOrdersApp.viewOrderDetails('${order.id}')">View</button>
                            <button class="btn btn-success" onclick="adminOrdersApp.updateOrderStatus('${order.id}', 'confirmed')">Confirm</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            // Apply filters
            applyFilters() {
                const statusFilter = document.getElementById('statusFilter').value;
                const dateFilter = document.getElementById('dateFilter').value;
                const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

                this.filteredOrders = this.orders.filter(order => {
                    if (statusFilter && order.status !== statusFilter) return false;
                    if (dateFilter && !order.orderDate.startsWith(dateFilter)) return false;
                    if (searchFilter && !order.id.toLowerCase().includes(searchFilter) &&
                        !order.customerName.toLowerCase().includes(searchFilter)) return false;
                    return true;
                });

                this.renderOrdersTable();
            }

            // Update statistics
            updateStats() {
                const totalOrders = this.orders.length;
                const pendingOrders = this.orders.filter(o => o.status === 'pending').length;
                const todayOrders = this.orders.filter(o => {
                    const orderDate = new Date(o.orderDate).toDateString();
                    const today = new Date().toDateString();
                    return orderDate === today;
                });
                const todayRevenue = todayOrders.reduce((sum, order) => sum + order.total, 0);
                const avgOrderValue = totalOrders > 0 ? Math.round(this.orders.reduce((sum, order) => sum + order.total, 0) / totalOrders) : 0;

                document.getElementById('totalOrders').textContent = totalOrders;
                document.getElementById('pendingOrders').textContent = pendingOrders;
                document.getElementById('todayRevenue').textContent = `â‚¹${todayRevenue}`;
                document.getElementById('avgOrderValue').textContent = `â‚¹${avgOrderValue}`;
            }

            // Update connection status
            updateConnectionStatus(status) {
                this.connectionStatus = status;
                const statusEl = document.getElementById('connectionStatus');
                const indicator = document.getElementById('realTimeIndicator');

                switch (status) {
                    case 'connected':
                        statusEl.textContent = 'ðŸŸ¢ Connected';
                        statusEl.className = 'connection-status connected';
                        indicator.style.display = 'inline-block';
                        break;
                    case 'connecting':
                        statusEl.textContent = 'ðŸŸ¡ Connecting...';
                        statusEl.className = 'connection-status';
                        indicator.style.display = 'none';
                        break;
                    case 'disconnected':
                        statusEl.textContent = 'ðŸ”´ Disconnected';
                        statusEl.className = 'connection-status disconnected';
                        indicator.style.display = 'none';
                        break;
                    case 'error':
                        statusEl.textContent = 'âŒ Connection Error';
                        statusEl.className = 'connection-status disconnected';
                        indicator.style.display = 'none';
                        break;
                }
            }

            // Show notifications
            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = 'notification-toast';
                notification.style.background = type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : type === 'warning' ? '#fff3cd' : '#d1ecf1';
                notification.style.color = type === 'success' ? '#155724' : type === 'error' ? '#721c24' : type === 'warning' ? '#856404' : '#0c5460';
                notification.textContent = message;

                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }

            // Update notification badge
            updateNotificationBadge() {
                const pendingCount = this.orders.filter(o => o.status === 'pending').length;
                const badge = document.getElementById('notificationBadge');
                badge.textContent = pendingCount;
                badge.style.display = pendingCount > 0 ? 'inline-block' : 'none';
            }

            // View order details
            viewOrderDetails(orderId) {
                const order = this.orders.find(o => o.id === orderId);
                if (!order) return;

                this.currentOrderId = orderId;

                // Populate modal
                document.getElementById('modalOrderId').textContent = order.id;
                document.getElementById('modalCustomerName').textContent = order.customerName;
                document.getElementById('modalCustomerPhone').textContent = order.customerPhone;
                document.getElementById('modalCustomerEmail').textContent = order.customerEmail;
                document.getElementById('modalOrderDate').textContent = new Date(order.orderDate).toLocaleString();
                document.getElementById('modalDeliveryAddress').textContent = order.deliveryAddress;
                document.getElementById('modalPaymentMethod').textContent = order.paymentMethod;
                document.getElementById('modalOrderStatus').textContent = order.status.charAt(0).toUpperCase() + order.status.slice(1);
                document.getElementById('modalOrderTotal').textContent = `â‚¹${order.total}`;
                document.getElementById('modalOrderItemsCount').textContent = order.items.reduce((sum, item) => sum + item.quantity, 0);

                // Populate order items
                const itemsContainer = document.getElementById('modalOrderItems');
                itemsContainer.innerHTML = '';
                order.items.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'order-item';
                    itemDiv.innerHTML = `
                        <span>${item.name} (x${item.quantity})</span>
                        <span>â‚¹${item.price * item.quantity}</span>
                    `;
                    itemsContainer.appendChild(itemDiv);
                });

                // Set status dropdown
                document.getElementById('statusUpdateSelect').value = order.status;

                // Show modal
                document.getElementById('orderDetailsModal').style.display = 'block';
            }

            // Close order details
            closeOrderDetails() {
                document.getElementById('orderDetailsModal').style.display = 'none';
                this.currentOrderId = null;
            }

            // Update order status
            async updateOrderStatus(orderId, newStatus) {
                if (!orderId) {
                    orderId = this.currentOrderId;
                    newStatus = document.getElementById('statusUpdateSelect').value;
                }

                try {
                    const response = await fetch(`/api/orders/${orderId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: newStatus })
                    });

                    if (response.ok) {
                        // Update local data
                        const order = this.orders.find(o => o.id === orderId);
                        if (order) {
                            order.status = newStatus;
                            this.applyFilters();
                            this.updateStats();
                        }

                        // Notify via WebSocket
                        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                            this.ws.send(JSON.stringify({
                                type: 'order_updated',
                                order: { id: orderId, status: newStatus }
                            }));
                        }

                        this.showNotification(`Order ${orderId} status updated to ${newStatus}`, 'success');
                        this.closeOrderDetails();
                    } else {
                        throw new Error('Failed to update order status');
                    }
                } catch (error) {
                    console.error('Error updating order status:', error);
                    this.showNotification('Error updating order status', 'error');
                }
            }

            // Setup event listeners
            setupEventListeners() {
                // Menu toggle
                document.getElementById('menuToggle').addEventListener('click', () => {
                    document.getElementById('sidebar').classList.toggle('collapsed');
                });

                // Filters
                document.getElementById('statusFilter').addEventListener('change', () => this.applyFilters());
                document.getElementById('dateFilter').addEventListener('change', () => this.applyFilters());
                document.getElementById('searchFilter').addEventListener('input', () => this.applyFilters());

                // Modal close
                document.getElementById('orderDetailsModal').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('orderDetailsModal')) {
                        this.closeOrderDetails();
                    }
                });
            }
        }

        // Initialize the app
        const adminOrdersApp = new AdminOrdersApp();

        // Global functions for HTML onclick handlers
        function viewOrderDetails(orderId) {
            adminOrdersApp.viewOrderDetails(orderId);
        }

        function updateOrderStatus(orderId, status) {
            adminOrdersApp.updateOrderStatus(orderId, status);
        }

        function closeOrderDetails() {
            adminOrdersApp.closeOrderDetails();
        }

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
