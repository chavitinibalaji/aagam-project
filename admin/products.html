<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AAGAM Admin - Products Management</title>
    <link rel="stylesheet" href="css/admin.css">
    <style>
        .products-container { padding: 20px; }
        .products-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .products-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-value { font-size: 24px; font-weight: bold; color: #3498db; }
        .stat-label { color: #666; margin-top: 5px; }
        .products-table { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .products-table table { width: 100%; border-collapse: collapse; }
        .products-table th, .products-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        .products-table th { background: #f8f9fa; font-weight: 600; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .status-active { background: #d4edda; color: #155724; }
        .status-inactive { background: #f8d7da; color: #721c24; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #3498db; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; margin: 5% auto; padding: 20px; border-radius: 8px; width: 90%; max-width: 600px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .connection-status { position: fixed; top: 10px; right: 10px; padding: 5px 10px; border-radius: 20px; font-size: 12px; z-index: 1000; }
        .connection-status.connected { background: #d4edda; color: #155724; }
        .connection-status.disconnected { background: #f8d7da; color: #721c24; }
        .real-time-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #28a745; margin-left: 5px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>AAGAM Admin</h2>
        </div>
        <nav class="sidebar-nav">
            <a href="index.html" class="nav-item">
                <span class="icon">ðŸ“Š</span> Dashboard
            </a>
            <a href="products.html" class="nav-item active">
                <span class="icon">ðŸ“¦</span> Products
            </a>
            <a href="orders.html" class="nav-item">
                <span class="icon">ðŸ“‹</span> Orders
            </a>
            <a href="inventory.html" class="nav-item">
                <span class="icon">ðŸ“ˆ</span> Inventory
            </a>
            <a href="#" class="nav-item">
                <span class="icon">ðŸ‘¥</span> Users
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Topbar -->
        <div class="topbar">
            <div class="topbar-left">
                <button class="menu-toggle" id="menuToggle">â˜°</button>
                <h1>Products Management <span class="real-time-indicator" id="realTimeIndicator"></span></h1>
            </div>
            <div class="topbar-right">
                <div class="notifications">
                    <span class="icon">ðŸ””</span>
                    <span class="badge" id="notificationBadge">0</span>
                </div>
                <div class="user-profile">
                    <span class="icon">ðŸ‘¤</span>
                    <span>Admin</span>
                </div>
            </div>
        </div>

        <!-- Products Content -->
        <div class="products-container">
            <!-- Stats Cards -->
            <div class="products-stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalProducts">0</div>
                    <div class="stat-label">Total Products</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeProducts">0</div>
                    <div class="stat-label">Active Products</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="lowStockProducts">0</div>
                    <div class="stat-label">Low Stock Items</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalCategories">0</div>
                    <div class="stat-label">Categories</div>
                </div>
            </div>

            <!-- Products Header -->
            <div class="products-header">
                <h2>Product Inventory</h2>
                <button class="btn btn-primary" onclick="openProductModal()">Add New Product</button>
            </div>

            <!-- Products Table -->
            <div class="products-table">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Price</th>
                            <th>Stock</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        <!-- Products will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <h3 id="productModalTitle">Add Product</h3>
            <form id="productForm">
                <div class="form-group">
                    <label for="productName">Product Name</label>
                    <input type="text" id="productName" required>
                </div>
                <div class="form-group">
                    <label for="productCategory">Category</label>
                    <select id="productCategory" required>
                        <option value="">Select Category</option>
                        <option value="groceries">Groceries</option>
                        <option value="vegetables">Vegetables</option>
                        <option value="fruits">Fruits</option>
                        <option value="dairy">Dairy</option>
                        <option value="beverages">Beverages</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="productPrice">Price (â‚¹)</label>
                    <input type="number" id="productPrice" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="productStock">Stock Quantity</label>
                    <input type="number" id="productStock" required>
                </div>
                <div class="form-group">
                    <label for="productDescription">Description</label>
                    <textarea id="productDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="productImage">Image URL</label>
                    <input type="url" id="productImage">
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeProductModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Product</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Connection Status -->
    <div class="connection-status" id="connectionStatus">Connecting...</div>

    <script src="js/admin-products.js"></script>
    <script>
        // Real-time WebSocket connection for admin products
        class AdminProductsApp {
            constructor() {
                this.ws = null;
                this.products = [];
                this.connectionStatus = 'disconnected';
                this.init();
            }

            init() {
                this.connectWebSocket();
                this.setupEventListeners();
                this.loadProducts();
                this.updateStats();
            }

            // WebSocket connection
            connectWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}`;

                try {
                    this.ws = new WebSocket(wsUrl);
                    this.updateConnectionStatus('connecting');

                    this.ws.onopen = () => {
                        this.updateConnectionStatus('connected');
                        this.authenticate();
                        this.showNotification('Connected to real-time server', 'success');
                    };

                    this.ws.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        this.handleWebSocketMessage(data);
                    };

                    this.ws.onclose = () => {
                        this.updateConnectionStatus('disconnected');
                        this.showNotification('Disconnected from server', 'warning');
                        // Auto reconnect
                        setTimeout(() => this.connectWebSocket(), 5000);
                    };

                    this.ws.onerror = () => {
                        this.updateConnectionStatus('error');
                    };
                } catch (error) {
                    console.error('WebSocket connection failed:', error);
                    this.updateConnectionStatus('error');
                }
            }

            // Authenticate as admin
            authenticate() {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({
                        type: 'admin_auth',
                        token: localStorage.getItem('admin_token') || 'admin_session'
                    }));
                }
            }

            // Handle WebSocket messages
            handleWebSocketMessage(data) {
                console.log('Admin received:', data.type);

                switch (data.type) {
                    case 'product_updated':
                        this.onProductUpdated(data.product);
                        break;
                    case 'product_added':
                        this.onProductAdded(data.product);
                        break;
                    case 'product_deleted':
                        this.onProductDeleted(data.productId);
                        break;
                    case 'inventory_alert':
                        this.onInventoryAlert(data.alert);
                        break;
                    case 'sales_update':
                        this.onSalesUpdate(data.sales);
                        break;
                }
            }

            // Real-time product updates
            onProductUpdated(product) {
                const index = this.products.findIndex(p => p.id === product.id);
                if (index !== -1) {
                    this.products[index] = product;
                    this.renderProductsTable();
                    this.updateStats();
                    this.showNotification(`Product "${product.name}" updated`, 'info');
                }
            }

            onProductAdded(product) {
                this.products.push(product);
                this.renderProductsTable();
                this.updateStats();
                this.showNotification(`New product "${product.name}" added`, 'success');
            }

            onProductDeleted(productId) {
                this.products = this.products.filter(p => p.id !== productId);
                this.renderProductsTable();
                this.updateStats();
                this.showNotification('Product deleted', 'warning');
            }

            onInventoryAlert(alert) {
                this.showNotification(`Low stock alert: ${alert.productName}`, 'warning');
                this.updateNotificationBadge();
            }

            onSalesUpdate(sales) {
                // Update sales-related stats if needed
                this.updateStats();
            }

            // Load products from API
            async loadProducts() {
                try {
                    const response = await fetch('/api/products');
                    const data = await response.json();
                    this.products = data.products || [];
                    this.renderProductsTable();
                    this.updateStats();
                } catch (error) {
                    console.error('Error loading products:', error);
                    // Fallback to local data
                    try {
                        const response = await fetch('../data/products.json');
                        const data = await response.json();
                        this.products = data.products || [];
                        this.renderProductsTable();
                        this.updateStats();
                    } catch (fallbackError) {
                        console.error('Fallback error:', fallbackError);
                        this.products = [];
                    }
                }
            }

            // Render products table
            renderProductsTable() {
                const tbody = document.getElementById('productsTableBody');
                tbody.innerHTML = '';

                this.products.forEach(product => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${product.id || 'N/A'}</td>
                        <td>${product.name}</td>
                        <td>${product.cat || product.category || 'N/A'}</td>
                        <td>â‚¹${product.price}</td>
                        <td>${product.stock || 0}</td>
                        <td><span class="status-badge ${product.stock > 0 ? 'status-active' : 'status-inactive'}">${product.stock > 0 ? 'Active' : 'Out of Stock'}</span></td>
                        <td>
                            <button class="btn btn-secondary" onclick="adminProductsApp.editProduct(${product.id})">Edit</button>
                            <button class="btn btn-danger" onclick="adminProductsApp.deleteProduct(${product.id})">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            // Update statistics
            updateStats() {
                const totalProducts = this.products.length;
                const activeProducts = this.products.filter(p => p.stock > 0).length;
                const lowStockProducts = this.products.filter(p => p.stock <= 5 && p.stock > 0).length;
                const categories = new Set(this.products.map(p => p.cat || p.category).filter(Boolean));

                document.getElementById('totalProducts').textContent = totalProducts;
                document.getElementById('activeProducts').textContent = activeProducts;
                document.getElementById('lowStockProducts').textContent = lowStockProducts;
                document.getElementById('totalCategories').textContent = categories.size;
            }

            // Update connection status
            updateConnectionStatus(status) {
                this.connectionStatus = status;
                const statusEl = document.getElementById('connectionStatus');
                const indicator = document.getElementById('realTimeIndicator');

                switch (status) {
                    case 'connected':
                        statusEl.textContent = 'ðŸŸ¢ Connected';
                        statusEl.className = 'connection-status connected';
                        indicator.style.display = 'inline-block';
                        break;
                    case 'connecting':
                        statusEl.textContent = 'ðŸŸ¡ Connecting...';
                        statusEl.className = 'connection-status';
                        indicator.style.display = 'none';
                        break;
                    case 'disconnected':
                        statusEl.textContent = 'ðŸ”´ Disconnected';
                        statusEl.className = 'connection-status disconnected';
                        indicator.style.display = 'none';
                        break;
                    case 'error':
                        statusEl.textContent = 'âŒ Connection Error';
                        statusEl.className = 'connection-status disconnected';
                        indicator.style.display = 'none';
                        break;
                }
            }

            // Show notifications
            showNotification(message, type = 'info') {
                // Create notification element
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : type === 'warning' ? '#fff3cd' : '#d1ecf1'};
                    color: ${type === 'success' ? '#155724' : type === 'error' ? '#721c24' : type === 'warning' ? '#856404' : '#0c5460'};
                    padding: 12px 20px;
                    border-radius: 8px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                    z-index: 1000;
                    animation: slideIn 0.3s ease;
                `;
                notification.textContent = message;

                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }

            // Update notification badge
            updateNotificationBadge() {
                const badge = document.getElementById('notificationBadge');
                const lowStockCount = this.products.filter(p => p.stock <= 5 && p.stock > 0).length;
                badge.textContent = lowStockCount;
                badge.style.display = lowStockCount > 0 ? 'inline-block' : 'none';
            }

            // Modal functions
            openProductModal(productId = null) {
                const modal = document.getElementById('productModal');
                const form = document.getElementById('productForm');
                const title = document.getElementById('productModalTitle');

                if (productId) {
                    const product = this.products.find(p => p.id === productId);
                    if (product) {
                        title.textContent = 'Edit Product';
                        document.getElementById('productName').value = product.name;
                        document.getElementById('productCategory').value = product.cat || product.category;
                        document.getElementById('productPrice').value = product.price;
                        document.getElementById('productStock').value = product.stock;
                        document.getElementById('productDescription').value = product.description || '';
                        document.getElementById('productImage').value = product.img || '';
                        this.currentProductId = productId;
                    }
                } else {
                    title.textContent = 'Add Product';
                    form.reset();
                    this.currentProductId = null;
                }

                modal.style.display = 'block';
            }

            closeProductModal() {
                document.getElementById('productModal').style.display = 'none';
            }

            // Save product
            async saveProduct(formData) {
                try {
                    const productData = {
                        id: this.currentProductId || Date.now(),
                        name: formData.get('name'),
                        cat: formData.get('category'),
                        price: parseFloat(formData.get('price')),
                        stock: parseInt(formData.get('stock')),
                        description: formData.get('description'),
                        img: formData.get('image'),
                        status: 'active'
                    };

                    // Send to server
                    const method = this.currentProductId ? 'PUT' : 'POST';
                    const url = this.currentProductId ? `/api/products/${this.currentProductId}` : '/api/products';

                    const response = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(productData)
                    });

                    if (response.ok) {
                        // Notify via WebSocket
                        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                            this.ws.send(JSON.stringify({
                                type: this.currentProductId ? 'product_updated' : 'product_added',
                                product: productData
                            }));
                        }

                        this.closeProductModal();
                        this.showNotification(`Product ${this.currentProductId ? 'updated' : 'added'} successfully!`, 'success');
                        this.loadProducts(); // Refresh data
                    } else {
                        throw new Error('Failed to save product');
                    }
                } catch (error) {
                    console.error('Error saving product:', error);
                    this.showNotification('Error saving product', 'error');
                }
            }

            // Delete product
            async deleteProduct(productId) {
                if (!confirm('Are you sure you want to delete this product?')) return;

                try {
                    const response = await fetch(`/api/products/${productId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        // Notify via WebSocket
                        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                            this.ws.send(JSON.stringify({
                                type: 'product_deleted',
                                productId: productId
                            }));
                        }

                        this.showNotification('Product deleted successfully!', 'warning');
                        this.loadProducts(); // Refresh data
                    } else {
                        throw new Error('Failed to delete product');
                    }
                } catch (error) {
                    console.error('Error deleting product:', error);
                    this.showNotification('Error deleting product', 'error');
                }
            }

            // Setup event listeners
            setupEventListeners() {
                // Menu toggle
                document.getElementById('menuToggle').addEventListener('click', () => {
                    document.getElementById('sidebar').classList.toggle('collapsed');
                });

                // Product form submission
                document.getElementById('productForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    this.saveProduct(formData);
                });

                // Close modal when clicking outside
                document.getElementById('productModal').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('productModal')) {
                        this.closeProductModal();
                    }
                });
            }
        }

        // Initialize the app
        const adminProductsApp = new AdminProductsApp();

        // Global functions for HTML onclick handlers
        function openProductModal(productId) {
            adminProductsApp.openProductModal(productId);
        }

        function closeProductModal() {
            adminProductsApp.closeProductModal();
        }

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
